# CoreDNS configuration for WireGuard WebAdmin
# Provides DNS resolution for peer hostnames and external queries

# Internal WireGuard zone for peer resolution
wg.local {
    # Enable logging for this zone
    log
    
    # Enable errors plugin for better error reporting
    errors
    
    # Load peer zone file
    file /etc/coredns/zones/peers.db
    
    # Enable auto-reload of zone files
    reload 5s
    
    # Forward unknown queries to upstream
    forward . 1.1.1.1 1.0.0.1 8.8.8.8 {
        policy round_robin
        health_check 5s
    }
    
    # Cache responses for better performance
    cache 30s
}

# Instance zone for WireGuard instances
instances.wg.local {
    # Enable logging for this zone
    log
    
    # Enable errors plugin for better error reporting
    errors
    
    # Load instance zone file
    file /etc/coredns/zones/instances.db
    
    # Enable auto-reload of zone files
    reload 5s
    
    # Forward unknown queries to upstream
    forward . 1.1.1.1 1.0.0.1 8.8.8.8 {
        policy round_robin
        health_check 5s
    }
    
    # Cache responses for better performance
    cache 30s
}

# Global options for all other queries
. {
    # Enable logging
    log
    
    # Enable errors plugin for better error reporting
    errors
    
    # Enable health check endpoint
    health {
        lameduck 5s
    }
    
    # Enable metrics on port 9153
    prometheus :9153
    
    # Enable ready endpoint
    ready
    
    # Forward all other queries to upstream DNS servers
    forward . 1.1.1.1 1.0.0.1 8.8.8.8 {
        # Use Cloudflare and Google DNS as upstream
        policy round_robin
        health_check 5s
    }
    
    # Cache responses for better performance
    cache 30s
}
