{% extends "base.html" %}
{% load i18n %}
{% block page_custom_head %}
    <style>
        .peer-extra-info {
            display: none;
        }
        .callout.position-relative {
            padding: 0 !important;
        }
        @keyframes blink {
            50% { opacity: 0; }
        }
        .blinking-icon {
            animation: blink 1s step-start infinite;
        }
        #inviteTextContainer {
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #f9f9f9;
        }

        #inviteText {
            white-space: pre-line;
            text-align: left;
        }

        /* Hub and Spoke Visualization */
        .hub-spoke-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
            position: relative;
            min-height: 500px;
        }
        
        .hub-spoke-svg {
            width: 100%;
            height: 500px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }
        
        .hub-center {
            fill: #007bff;
            stroke: #0056b3;
            stroke-width: 3;
            cursor: pointer;
        }
        
        .hub-center-text {
            fill: white;
            font-family: 'Arial', sans-serif;
            font-size: 14px;
            font-weight: bold;
            text-anchor: middle;
            dominant-baseline: central;
            pointer-events: none;
        }
        
        .peer-node {
            fill: #28a745;
            stroke: #1e7e34;
            stroke-width: 2;
            cursor: pointer;
        }
        
        .peer-node.warning {
            fill: #ffc107;
            stroke: #e0a800;
        }
        
        .peer-node.offline {
            fill: #dc3545;
            stroke: #c82333;
        }
        
        .peer-connection {
            stroke: #6c757d;
            stroke-width: 2;
            fill: none;
            opacity: 0.6;
            transition: all 0.3s ease;
        }
        
        .peer-connection:hover {
            stroke: #007bff;
            stroke-width: 3;
            opacity: 1;
        }
        
        .peer-label {
            fill: #2c3e50;
            font-family: 'Arial', sans-serif;
            font-size: 13px;
            font-weight: 600;
            text-anchor: middle;
            dominant-baseline: central;
            pointer-events: none;
        }
        
        .peer-ip-label {
            fill: #6c757d;
            font-family: 'Courier New', monospace;
            font-size: 10px;
            text-anchor: middle;
            dominant-baseline: central;
            pointer-events: none;
        }
        
        .peer-stats {
            fill: #28a745;
            font-family: 'Arial', sans-serif;
            font-size: 10px;
            font-weight: 500;
            text-anchor: middle;
            dominant-baseline: central;
            pointer-events: none;
        }
        
        .view-toggle {
            position: absolute;
            top: 16px;
            right: 16px;
            z-index: 10;
        }
        
        .peer-tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .peer-tooltip.show {
            opacity: 1;
        }
        
        .peer-tooltip .peer-name {
            font-weight: bold;
            margin-bottom: 4px;
        }
        
        .peer-tooltip .peer-info {
            color: #ccc;
            font-size: 11px;
        }

        /* Modern Table Styling */
        .peers-table {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .peers-table .table {
            margin-bottom: 0;
        }
        
        .peers-table .table th {
            background: #f8f9fa;
            border: none;
            font-weight: 600;
            color: #495057;
            padding: 12px 16px;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .peers-table .table td {
            border: none;
            padding: 16px;
            vertical-align: middle;
            border-bottom: 1px solid #e9ecef;
        }
        
        .peers-table .table tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        .peers-table .table tbody tr:last-child td {
            border-bottom: none;
        }
        
        .peer-name {
            font-weight: 600;
            color: #2c3e50;
            text-decoration: none;
        }
        
        .peer-name:hover {
            color: #3498db;
            text-decoration: none;
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-online { background-color: #28a745; }
        .status-warning { background-color: #ffc107; }
        .status-offline { background-color: #dc3545; }
        
        .peer-actions {
            white-space: nowrap;
        }
        
        .peer-actions .btn {
            margin-right: 4px;
            padding: 4px 8px;
            font-size: 0.75rem;
        }
        
        .traffic-chart {
            width: 80px;
            height: 40px;
        }
        
        .compact-info {
            font-size: 0.8rem;
            color: #6c757d;
        }
        
        .peer-ip {
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            color: #495057;
        }
        
        .throughput-display {
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .transfer-display {
            font-size: 0.75rem;
            color: #6c757d;
        }
        
        .handshake-display {
            font-size: 0.75rem;
            color: #6c757d;
        }
        
        .table-controls {
            background: #f8f9fa;
            padding: 16px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .table-controls .btn-group .btn {
            margin-right: 0;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 16px;
            color: #dee2e6;
        }
        
        @media (max-width: 768px) {
            .peers-table .table th,
            .peers-table .table td {
                padding: 8px 12px;
                font-size: 0.8rem;
            }
            
            .peer-actions .btn {
                padding: 2px 6px;
                font-size: 0.7rem;
            }
            
            .traffic-chart {
                width: 60px;
                height: 30px;
            }
        }
    </style>
{% endblock %}


{% block content %}
    {% if wireguard_instances %}
        <div class="card card-primary card-outline">
            <div class="card-body p-0">
                <!-- Instance Tabs -->
                <ul class="nav nav-tabs" role="tablist" style="margin-bottom: 0;">
                    {% for wgconf in wireguard_instances %}
                        <li class="nav-item">
                            <a class="nav-link {% if wgconf == current_instance %}active{% endif %}" href="/peer/list/?uuid={{ wgconf.uuid }}" role="tab">
                                <i class="fas fa-network-wired"></i>
                                wg{{ wgconf.instance_id }} {% if wgconf.name %}({{ wgconf.name }}){% endif %}
                            </a>
                        </li>
                    {% endfor %}
                </ul>
                
                <!-- View Controls -->
                <div class="table-controls">
                    <div class="d-flex align-items-center">
                        <h6 class="mb-0 mr-3">
                            <i class="fas fa-users"></i>
                            {% trans 'Peers' %} ({{ peer_list|length }})
                        </h6>
                        <div class="btn-group btn-group-sm" role="group">
                            <button id="toggleExtraInfo" class="btn btn-outline-secondary">
                                <i class="fas fa-eye"></i> {% trans 'Show Details' %}
                            </button>
                            <button class="btn btn-outline-secondary" onclick="location.reload()">
                                <i class="fas fa-sync-alt"></i> {% trans 'Refresh' %}
                            </button>
                        </div>
                    </div>
                    <div class="d-flex align-items-center">
                        <div class="btn-group btn-group-sm mr-3" role="group">
                            <button id="viewTable" class="btn btn-outline-primary active">
                                <i class="fas fa-table"></i> {% trans 'Table' %}
                            </button>
                            <button id="viewHub" class="btn btn-outline-primary">
                                <i class="fas fa-project-diagram"></i> {% trans 'Hub View' %}
                            </button>
                        </div>
                        {% if add_peer_enabled %}
                            <a class="btn btn-primary btn-sm" href="/peer/manage/?instance={{ current_instance.uuid }}" onclick="return confirm('{% trans 'Are you sure you want to create a new peer?' %}');">
                                <i class="fas fa-plus"></i> {% trans 'Create Peer' %}
                            </a>
                        {% else %}
                            <a class="btn btn-primary btn-sm disabled" href="">
                                <i class="fas fa-plus"></i> {% trans 'Create Peer' %}
                            </a>
                        {% endif %}
                                                        </div>
                                                      </div>

                <!-- Peers Table -->
                <div class="peers-table" id="tableView">
                    {% if peer_list %}
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th width="5%">
                                        <i class="fas fa-circle"></i>
                                    </th>
                                    <th width="20%">{% trans 'Peer' %}</th>
                                    <th width="15%">{% trans 'IP Address' %}</th>
                                    <th width="15%">{% trans 'Throughput' %}</th>
                                    <th width="15%">{% trans 'Transfer' %}</th>
                                    <th width="15%">{% trans 'Last Handshake' %}</th>
                                    <th width="10%">{% trans 'Traffic' %}</th>
                                    <th width="5%">{% trans 'Actions' %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for peer in peer_list %}
                                    <tr id="peer-{{ peer.public_key }}" data-uuid="{{ peer.uuid }}">
                                        <td>
                                            <span class="status-indicator status-offline" id="status-{{ peer.public_key }}"></span>
                                        </td>
                                        <td>
                                            <div>
                                                <a href="#" onclick="openPeerModal('{{ peer.uuid }}');" class="peer-name" id="peer-name-{{ peer.public_key }}">
                                                    {{ peer }}
                                                </a>
                                                <div class="compact-info peer-extra-info" id="peer-endpoints-{{ peer.public_key }}"></div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="peer-ip" id="peer-allowed-ips-{{ peer.public_key }}">
                                                    {% for address in peer.peerallowedip_set.all %}
                                                        {% if address.priority == 0 and address.config_file == 'server' %}
                                                        {{ address.allowed_ip }}/{{ address.netmask }}
                                                        {% endif %}
                                                    {% endfor %}
                                            </div>
                                        </td>
                                        <td>
                                            <div class="throughput-display" id="peer-throughput-{{ peer.public_key }}">
                                                <i class="fas fa-arrow-down text-primary"></i> -- Kbps, 
                                                <i class="fas fa-arrow-up text-success"></i> -- Kbps
                                            </div>
                                        </td>
                                        <td>
                                            <div class="transfer-display" id="peer-transfer-{{ peer.public_key }}">
                                                -- TX, -- RX
                                            </div>
                                        </td>
                                        <td>
                                            <div class="handshake-display" id="peer-latest-handshake-{{ peer.public_key }}">
                                                --
                                            </div>
                                            <span style="display: none;" id="peer-stored-latest-handshake-{{ peer.public_key }}">
                                                {% if peer.peerstatus.last_handshake %}{{ peer.peerstatus.last_handshake|date:"U" }}{% else %}0{% endif %}
                                            </span>
                                        </td>
                                        <td>
                                            <canvas class="traffic-chart" id="chart-{{ peer.public_key }}" width="80" height="40"></canvas>
                                        </td>
                                        <td>
                                            <div class="peer-actions">
                                                {% if user_acl.user_level >= 30 %}
                                                    <div class="btn-group-vertical btn-group-sm">
                                                        <a href="/peer/sort/?peer={{ peer.uuid }}&direction=up" class="btn btn-outline-secondary btn-xs" title="{% trans 'Move Up' %}">
                                                            <i class="fas fa-chevron-up"></i>
                                                        </a>
                                                        <a href="/peer/sort/?peer={{ peer.uuid }}&direction=down" class="btn btn-outline-secondary btn-xs" title="{% trans 'Move Down' %}">
                                                            <i class="fas fa-chevron-down"></i>
                                                        </a>
                                                    </div>
                                                        {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                                    {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <h5>{% trans 'No Peers Found' %}</h5>
                            <p>{% trans 'No peers are configured for this WireGuard instance.' %}</p>
                            {% if add_peer_enabled %}
                                <a class="btn btn-primary" href="/peer/manage/?instance={{ current_instance.uuid }}">
                                    <i class="fas fa-plus"></i> {% trans 'Create Your First Peer' %}
                                </a>
                            {% endif %}
                                        </div>
                    {% endif %}
                                    </div>

                <!-- Hub and Spoke Visualization -->
                <div class="hub-spoke-container" id="hubView" style="display: none;">
                    <div class="view-toggle">
                        <div class="btn-group btn-group-sm" role="group">
                            <button id="hubViewTable" class="btn btn-outline-secondary btn-sm">
                                <i class="fas fa-table"></i> {% trans 'Table' %}
                            </button>
                            <button id="hubViewHub" class="btn btn-outline-secondary btn-sm active">
                                <i class="fas fa-project-diagram"></i> {% trans 'Hub View' %}
                            </button>
                                </div>
                        </div>
                    {% if peer_list %}
                        <svg class="hub-spoke-svg" id="hubSpokeSvg">
                            <!-- Hub center -->
                            <circle class="hub-center" cx="250" cy="250" r="40" data-uuid="{{ current_instance.uuid }}">
                                <title>WireGuard Server - {% if current_instance.name %}{{ current_instance.name }}{% else %}wg{{ current_instance.instance_id }}{% endif %}</title>
                            </circle>
                            <text class="hub-center-text" x="250" y="250">WG{{ current_instance.instance_id }}</text>
                            
                            <!-- Peer nodes and connections will be generated by JavaScript -->
                        </svg>
                        {% else %}
                        <div class="empty-state">
                            <i class="fas fa-project-diagram"></i>
                            <h5>{% trans 'No Peers Found' %}</h5>
                            <p>{% trans 'No peers are configured for this WireGuard instance.' %}</p>
                            {% if add_peer_enabled %}
                                <a class="btn btn-primary" href="/peer/manage/?instance={{ current_instance.uuid }}">
                                    <i class="fas fa-plus"></i> {% trans 'Create Your First Peer' %}
                                </a>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>

                <!-- Tooltip -->
                <div class="peer-tooltip" id="peerTooltip">
                    <div class="peer-name"></div>
                    <div class="peer-info"></div>
                </div>
            </div>
        </div>

        <!-- Peer Preview Modal -->
        <div class="modal fade" id="peerPreviewModal" tabindex="-1" aria-labelledby="peerPreviewModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="peerPreviewModalLabel">Peer Preview</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <!-- Info content section -->
                        <div class="info-content">
                            <p><b><i class="fas fa-arrows-alt-v nav-icon"></i> {% trans 'Throughput' %}:</b> <span id="peerThroughput">--</span></p>
                            <p><b><i class="fas fa-dolly nav-icon"></i> {% trans 'Transfer' %}:</b> <span id="peerTransfer">--</span></p>
                            <p><b><i class="far fa-clock nav-icon"></i> {% trans 'Latest Handshake' %}:</b> <span id="peerHandshake">--</span></p>
                            <p><b><i class="far fa-address-card nav-icon"></i> {% trans 'Endpoints' %}:</b> <span id="peerEndpoints">--</span></p>
                            <p><b><i class="fas fa-network-wired nav-icon"></i> {% trans 'Allowed IPs' %}:</b> <span id="peerAllowedIPs">--</span></p>

                            <!-- Traffic Graph -->
                            <div class="graph-container" style="margin-top:20px;">
                                <div class="d-flex justify-content-between align-items-center">
                                    <label>
                                        <i class="fas fa-chart-area nav-icon"></i>
                                        {% trans 'Peer Traffic' %}
                                    </label>
                                    <div class="btn-group" role="group" aria-label="Graph interval">
                                        <a href="#" data-period="1h" class="btn btn-outline-primary btn-xs">1h</a>
                                        <a href="#" data-period="3h" class="btn btn-outline-primary btn-xs">3h</a>
                                        <a href="#" data-period="6h" class="btn btn-outline-primary btn-xs">6h</a>
                                        <a href="#" data-period="1d" class="btn btn-outline-primary btn-xs">1d</a>
                                        <a href="#" data-period="7d" class="btn btn-outline-primary btn-xs">7d</a>
                                        <a href="#" data-period="30d" class="btn btn-outline-primary btn-xs">1m</a>
                                        <a href="#" data-period="90d" class="btn btn-outline-primary btn-xs">3m</a>
                                        <a href="#" data-period="180d" class="btn btn-outline-primary btn-xs">6m</a>
                                        <a href="#" data-period="365d" class="btn btn-outline-primary btn-xs">1y</a>
                                    </div>
                                </div>
                                <center style="margin-top:10px;">
                                    <img id="graphImg" src="" class="img-fluid" alt="{% trans 'No traffic history, please wait a few minutes' %}" style="display:block;">
                                </center>
                            </div>
                        </div>

                        <!-- QR Code content section (initially hidden) -->
                        <div class="qr-code-content" style="display:none; ">
                            <button class="btn btn-secondary" id="backButton"><i class="fas fa-times"></i> {% trans 'Close QR Code' %}</button><br>
                            <div style="text-align: center;">
                                <img id="qrCodeImg" src="" alt="QR Code" class="img-fluid" style="max-width: 400px" />
                            </div>
                        </div>

                        <!-- VPN Invite content section (initially hidden) -->
                        <div class="invite-content" style="display:none;">
                            <button class="btn btn-secondary" id="backFromInviteButton"><i class="fas fa-arrow-left"></i> {% trans 'Back' %}</button><br>
                            <div style="text-align: center; margin-top: 10px;">
                                <h5>{% trans 'VPN Invite Details' %}</h5>
                                <div id="inviteTextContainer">
                                    <p id="inviteText"></p>
                                </div>
                                <p id="invitePassword"></p>
                                <p>
                                    {% trans 'Expires on' %}: <span id="inviteExpiration"></span>
                                    <i class="fas fa-sync-alt" id="refreshInviteButton" style="cursor: pointer;" title="Refresh Invite"></i>
                                </p>
                                <div class="form-group">
                                    <label for="inviteContactInput">{% trans 'Enter Email or WhatsApp Number' %}:</label>
                                    <input type="text" class="form-control" id="inviteContactInput" placeholder="{% trans 'Email or phone number' %}">
                                </div>
                                <div>
                                    <button class="btn btn-outline-secondary" id="copyInviteTextButton"><i class="fas fa-copy"></i> {% trans 'Copy Text' %}</button>
                                    <button class="btn btn-success" id="sendInviteEmailButton"><i class="fas fa-envelope"></i> {% trans 'Email' %}</button>
                                    <button class="btn btn-success" id="sendInviteWhatsappButton"><i class="fab fa-whatsapp"></i> {% trans 'WhatsApp' %}</button>
                                    <button class="btn btn-secondary" id="closeInviteButton"><i class="far fa-trash-alt"></i> {% trans 'Delete' %}</button>
                                </div>
                                <div id="inviteMessage" style="margin-top: 10px;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal"><i class="fas fa-times"></i>  {% trans 'Close' %}</button>
                        <a href="#" class="btn btn-info" id="downloadConfigButton"><i class="fas fa-download"></i> {% trans 'Config' %}</a>
                        <a href="#" class="btn btn-info" id="qrcodeButton"><i class="fas fa-qrcode"></i> {% trans 'QR Code' %}</a>
                        <a href="#" class="btn btn-info" id="inviteButton"><i class="fas fa-share"></i> {% trans 'VPN Invite' %}</a>
                         <a href="#" class="btn btn-outline-primary" id="generatenxs"
   onclick="showNxsAlertAndDownload();"><i class="fas fa-tv"></i> {% trans 'NoMachine File' %}</a>
                        <a href="#" class="btn btn-outline-primary" id="editPeerButton"><i class="far fa-edit"></i> {% trans 'Edit' %}</a>
                                               
                    </div>
                </div>
            </div>
        </div>

    {% else %}
        <div class="alert alert-warning" role="alert">
            <h4 class="alert-heading">{% trans 'No WireGuard Instances Found' %}</h4>
            <p>{% trans 'There are no WireGuard instances configured. You can add a new instance by clicking the button below.' %}</p>
        </div>
        <p>
            <a href="/server/manage/" class="btn btn-primary">{% trans 'Add WireGuard Instance' %}</a>
        </p>
    {% endif %}
{% endblock %}


{% block custom_page_scripts %}

    <script>
        // Global object to store Chart.js instances for each peer.
        var charts = {};

        // Initialize charts for each peer once the DOM is ready.
        document.addEventListener('DOMContentLoaded', function() {
            // For each canvas element matching id pattern "chart-<peer_public_key>"
            document.querySelectorAll('canvas[id^="chart-"]').forEach(function(canvas) {
                var peerId = canvas.id.replace('chart-', '');
                // Create a new Chart instance
                charts[peerId] = new Chart(canvas.getContext('2d'), {
                    type: 'line',
                    data: {
                        // X-axis labels can be blank since we are only showing the last 10 points.
                        labels: Array(10).fill(''),
                        datasets: [
                            {
                                label: 'Download',
                                data: Array(10).fill(0),
                                borderColor: 'rgba(54, 162, 235, 1)',
                                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                fill: false,
                                tension: 0.1,
                                lineTension: 0.4,
                                pointRadius: 0
                            },
                            {
                                label: 'Upload',
                                data: Array(10).fill(0),
                                borderColor: 'rgba(255, 99, 132, 1)',
                                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                fill: false,
                                tension: 0.1,
                                lineTension: 0.4,
                                pointRadius: 0
                            }
                        ]
                    },
                    options: {
                        legend: {
                            display: false
                        },
                        responsive: true,
                        scales: {
                            xAxes: [{
                                display: false,
                                ticks: { display: false },
                                gridLines: { display: false }
                            }],
                            yAxes: [{
                                display: false,
                                ticks: { display: false, beginAtZero: true },
                                gridLines: { display: false }
                            }]
                        },
                        animation: {
                            duration: 0
                        }
                    }
                });
            });
        });
    </script>


    <script>
        document.addEventListener('DOMContentLoaded', function() {
            $("#qrcodeButton").on("click", function(e) {
                e.preventDefault();
                var uuid = $("#peerPreviewModal").data("peer-uuid");
                $("#qrCodeImg").attr("src", "/tools/download_peer_config/?uuid=" + uuid + "&format=qrcode");
                $(".info-content").hide();
                $(".invite-content").hide();
                $(".qr-code-content").show();
            });

            $("#backButton").on("click", function(e) {
                e.preventDefault();
                $(".qr-code-content").hide();
                $(".info-content").show();
            });
        });
    </script>

    <script>
        function openPeerModal(uuid) {
            $(".qr-code-content").hide();
            $(".invite-content").hide();
            $(".info-content").show();
            $("#qrCodeImg").attr("src", "");
            $('#graphImg').attr('src', '').hide();
            
            // Find the peer element by its data-uuid attribute
            var peerElem = document.querySelector('[data-uuid="' + uuid + '"]');
            if (peerElem) {
                // Get peer name from the table row
                var peerNameFromCard = peerElem.querySelector('.peer-name').innerText;
                var peerThroughput = peerElem.querySelector('[id^="peer-throughput-"]').innerHTML;
                var peerTransfer = peerElem.querySelector('[id^="peer-transfer-"]').innerText;
                var peerHandshake = peerElem.querySelector('[id^="peer-latest-handshake-"]').innerText;
                var peerEndpoints = peerElem.querySelector('[id^="peer-endpoints-"]').innerText;
                var peerAllowedIPs = peerElem.querySelector('[id^="peer-allowed-ips-"]').innerHTML;

                // Update the modal fields with the table values
                $('#peerPreviewModalLabel').text(peerNameFromCard);
                $('#peerThroughput').html(peerThroughput);
                $('#peerTransfer').text(peerTransfer);
                $('#peerHandshake').text(peerHandshake);
                $('#peerEndpoints').text(peerEndpoints);
                $('#peerAllowedIPs').html(peerAllowedIPs);
                $('#editPeerButton').attr('href', '/peer/manage/?peer=' + uuid);
                $('#downloadConfigButton').attr('href', '/tools/download_peer_config/?uuid=' + uuid);
                $('#qrcodeButton').attr('href', '/tools/download_peer_config/?uuid=' + uuid + '&format=qrcode');
                $('#graphImg').attr('src', '/rrd/graph/?peer=' + uuid).show();
                $('#peerPreviewModal').data('peer-uuid', uuid);

                $.ajax({
                    url: '/api/peer_info/',
                    data: { uuid: uuid },
                    type: 'GET',
                    dataType: 'json',
                    success: function(data) {
                        if (data.name) {
                            $('#peerPreviewModalLabel').text(data.name);
                        }
                        // Future additional peer information can be handled here.
                    },
                    error: function(xhr, status, error) {
                        console.error("Error fetching peer info:", error);
                    }
                });
                $('#peerPreviewModal').modal('show');
            } else {
                console.error('Peer element not found for uuid: ' + uuid);
            }
        }

        $(document).on('click', '.graph-container .btn-group a', function(e) {
            e.preventDefault();
            var period = $(this).data('period');
            var uuid = $('#peerPreviewModal').data('peer-uuid');
            var newSrc = '/rrd/graph/?peer=' + uuid + '&period=' + period;
            $('#graphImg').attr('src', newSrc);
        });
    </script>

    <script>
        var previousMeasurements = {};
        var toastShownThisCycle = false;

        const updateThroughput = (peerId, peerInfo) => {
            const throughputElement = document.getElementById(`peer-throughput-${peerId}`);
            const currentTime = Date.now() / 1000; // current timestamp in seconds
            let formattedThroughput = '';

            if (previousMeasurements[peerId]) {
                const prev = previousMeasurements[peerId];
                const timeDiff = currentTime - prev.timestamp; // time difference in seconds

                // For the peer: download corresponds to tx and upload to rx
                let downloadDiff = peerInfo.transfer.tx - prev.transfer.tx;
                let uploadDiff = peerInfo.transfer.rx - prev.transfer.rx;

                // If counters have been reset (current value < previous), show a toast (only once per cycle)
                if (downloadDiff < 0 || uploadDiff < 0) {
                    if (!toastShownThisCycle) {
                        $(document).Toasts('create', {
                            class: 'bg-info',
                            title: 'info',
                            body: 'Throughput discarded due to counter reset',
                            delay: 10000,
                            autohide: true
                        });
                        toastShownThisCycle = true;
                    }
                    downloadDiff = 0;
                    uploadDiff = 0;
                }

                // Calculate throughput in bytes per second
                const downloadThroughput = downloadDiff / timeDiff;
                const uploadThroughput = uploadDiff / timeDiff;

                // Convert bytes per second to bits per second
                const downloadBps = downloadThroughput * 8;
                const uploadBps = uploadThroughput * 8;

                // Calculate Mbps and Kbps values
                const downloadMbps = downloadBps / 1000000;
                const uploadMbps = uploadBps / 1000000;
                const downloadKbps = downloadBps / 1000;
                const uploadKbps = uploadBps / 1000;

                // Determine display unit and formatting
                let downloadDisplay, uploadDisplay;
                if (downloadMbps < 1) {
                    // Below 1 Mbps, display in Kbps
                    if (downloadKbps < 100) {
                        downloadDisplay = downloadKbps.toFixed(2) + ' Kbps';
                    } else {
                        downloadDisplay = downloadKbps.toFixed(0) + ' Kbps';
                    }
                } else {
                    // 1 Mbps and above: if above 10 Mbps, show no decimals; else, show 2 decimals
                    downloadDisplay = (downloadMbps > 10 ? downloadMbps.toFixed(0) : downloadMbps.toFixed(2)) + ' Mbps';
                }
                if (uploadMbps < 1) {
                    if (uploadKbps < 10) {
                        uploadDisplay = uploadKbps.toFixed(2) + ' Kbps';
                    } else {
                        uploadDisplay = uploadKbps.toFixed(0) + ' Kbps';
                    }
                } else {
                    uploadDisplay = (uploadMbps > 10 ? uploadMbps.toFixed(0) : uploadMbps.toFixed(2)) + ' Mbps';
                }

                // Highlight values above a threshold
                const threshold = 100.0;
                if (downloadMbps > threshold) {
                    downloadDisplay = `<strong>${downloadDisplay}</strong>`;
                }
                if (uploadMbps > threshold) {
                    uploadDisplay = `<strong>${uploadDisplay}</strong>`;
                }

                formattedThroughput = `<i class="fas fa-arrow-down"></i> ${downloadDisplay}, <i class="fas fa-arrow-up"></i> ${uploadDisplay}`;
                throughputElement.innerHTML = formattedThroughput;

                // Update Chart.js graphs with raw Mbps values (always using Mbps for consistency)
                if (charts[peerId]) {
                    var chart = charts[peerId];
                    chart.data.datasets[0].data.push(downloadMbps);
                    if (chart.data.datasets[0].data.length > 10) {
                        chart.data.datasets[0].data.shift();
                    }
                    chart.data.datasets[1].data.push(uploadMbps);
                    if (chart.data.datasets[1].data.length > 10) {
                        chart.data.datasets[1].data.shift();
                    }
                    chart.update();
                }
            } else {
                // First cycle: no previous measurement available.
                formattedThroughput = `<i class="fas fa-arrow-down"></i> -.-- Kbps, <i class="fas fa-arrow-up"></i> -.-- Kbps`;
                throughputElement.innerHTML = formattedThroughput;
            }

            previousMeasurements[peerId] = {
                timestamp: currentTime,
                transfer: {
                    tx: peerInfo.transfer.tx,
                    rx: peerInfo.transfer.rx
                }
            };

            return formattedThroughput;
        };

        // Convert bytes to human-readable format with abbreviated units
        const convertBytes = (bytes) => {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        };

        // Fetch Wireguard status and update UI
        document.addEventListener('DOMContentLoaded', function() {
            const fetchWireguardStatus = async () => {
                try {
                    const response = await fetch('/api/wireguard_status/');
                    let data = await response.json();

                    // If latest-handshakes is 0, use the stored value
                    for (const [interfaceName, peers] of Object.entries(data)) {
                        for (const [peerId, peerInfo] of Object.entries(peers)) {
                            const peerElementId = `peer-stored-latest-handshake-${peerId}`;
                            const storedHandshakeElement = document.getElementById(peerElementId);
                            if (peerInfo['latest-handshakes'] === '0' && storedHandshakeElement) {
                                peerInfo['latest-handshakes'] = storedHandshakeElement.textContent;
                            }
                        }
                    }

                    updateUI(data);
                } catch (error) {
                    console.error('Error fetching Wireguard status:', error);
                }
            };

            fetchWireguardStatus();
            setInterval(fetchWireguardStatus, {{ current_instance.peer_list_refresh_interval|default:5 }} * 1000);
        });

        const updateUI = (data) => {
            // Reset the toast flag for this update cycle
            toastShownThisCycle = false;

            for (const [interfaceName, peers] of Object.entries(data)) {
                for (const [peerId, peerInfo] of Object.entries(peers)) {
                    const peerDiv = document.getElementById(`peer-${peerId}`);
                    if (peerDiv) {
                        updatePeerInfo(peerDiv, peerId, peerInfo);
                        updateCalloutClass(peerDiv, peerInfo['latest-handshakes']);
                        // Calculate throughput and update the card
                        const throughputHTML = updateThroughput(peerId, peerInfo);

                        // If the modal is active for this peer, update its fields as well.
                        const peerUuid = peerDiv.getAttribute("data-uuid");
                        if ($('#peerPreviewModal').is(':visible') && $('#peerPreviewModal').data('peer-uuid') === peerUuid) {
                            $('#peerThroughput').html(throughputHTML);
                            $('#peerTransfer').text(`${convertBytes(peerInfo.transfer.tx)} TX, ${convertBytes(peerInfo.transfer.rx)} RX`);
                            $('#peerHandshake').text(
                                peerInfo['latest-handshakes'] !== '0'
                                    ? new Date(parseInt(peerInfo['latest-handshakes']) * 1000).toLocaleString()
                                    : '0'
                            );
                            $('#peerEndpoints').text(peerInfo.endpoints);
                            const allowedIpsModalElement = document.getElementById('peerAllowedIPs');
                            checkAllowedIps(allowedIpsModalElement, peerInfo['allowed-ips']);
                        }
                    }
                }
            }
            
            // Update hub view if it's visible
            updateHubView();
        };

        const updatePeerInfo = (peerDiv, peerId, peerInfo) => {
            const escapedPeerId = peerId.replace(/([!"#$%&'()*+,.\/:;<=>?@[\]^`{|}~])/g, '\\$1');
            const transfer = peerDiv.querySelector(`#peer-transfer-${escapedPeerId}`);
            const latestHandshake = peerDiv.querySelector(`#peer-latest-handshake-${escapedPeerId}`);
            const endpoints = peerDiv.querySelector(`#peer-endpoints-${escapedPeerId}`);
            const allowedIps = peerDiv.querySelector(`#peer-allowed-ips-${escapedPeerId}`);

            transfer.textContent = `${convertBytes(peerInfo.transfer.tx)} TX, ${convertBytes(peerInfo.transfer.rx)} RX`;
            latestHandshake.textContent = `${peerInfo['latest-handshakes'] !== '0' ? new Date(parseInt(peerInfo['latest-handshakes']) * 1000).toLocaleString() : '0'}`;
            endpoints.textContent = `${peerInfo.endpoints}`;
            checkAllowedIps(allowedIps, peerInfo['allowed-ips']);
        };

        const checkAllowedIps = (allowedIpsElement, allowedIpsApiResponse) => {
            const apiIps = allowedIpsApiResponse[0].split(' ');
            const htmlIpsText = allowedIpsElement.textContent.trim();
            const htmlIpsArray = htmlIpsText.match(/\b(?:\d{1,3}\.){3}\d{1,3}\/\d{1,2}\b/g) || [];

            allowedIpsElement.innerHTML = '';
            let allowedIpsIssue = false;

            htmlIpsArray.forEach((ip, index, array) => {
                const ipSpan = document.createElement('span');
                ipSpan.textContent = ip;
                allowedIpsElement.appendChild(ipSpan);

                if (!apiIps.includes(ip)) {
                    ipSpan.style.color = 'red';
                    ipSpan.style.textDecoration = 'underline';
                    ipSpan.title = '{% trans 'This address does not appear in the wg show command output, likely indicating that another peer has an IP overlapping this network or that the configuration file is outdated.' %}';
                    allowedIpsIssue = true;
                }

                if (index < array.length - 1) {
                    allowedIpsElement.appendChild(document.createTextNode(', '));
                }
            });

            if (allowedIpsIssue) {
                const peerId = allowedIpsElement.id.replace('peer-allowed-ips-', '');
                const h5Element = document.getElementById('peer-name-' + peerId);
                if (h5Element && !h5Element.querySelector('.fa-exclamation-triangle')) {
                    const icon = document.createElement('i');
                    icon.className = 'fas fa-exclamation-triangle text-danger blinking-icon';
                    icon.title = '{% trans 'At least one address does not appear in the wg show command output, which may indicate that another peer is using an overlapping IP or that the configuration file is outdated.' %}';
                    h5Element.appendChild(icon);
                }
            }
        };

        const updateCalloutClass = (peerDiv, latestHandshake) => {
            const statusIndicator = peerDiv.querySelector('.status-indicator');
            const handshakeAge = Date.now() / 1000 - parseInt(latestHandshake);

            // Remove all status classes
            statusIndicator.classList.remove('status-online', 'status-warning', 'status-offline');

            if (latestHandshake === '0') {
                statusIndicator.classList.add('status-offline');
            } else if (handshakeAge < 600) {
                statusIndicator.classList.add('status-online');
            } else if (handshakeAge < 1800) {
                statusIndicator.classList.add('status-warning');
            } else if (handshakeAge < 21600) {
                statusIndicator.classList.add('status-warning');
            } else {
                statusIndicator.classList.add('status-offline');
            }
        };
    </script>

    <script>
        $(document).ready(function(){
            $("#toggleExtraInfo").click(function(){
                $(".peer-extra-info").toggle();
                if($(".peer-extra-info").is(":visible")){
                    $(this).html('<i class="fas fa-eye-slash"></i> {% trans "Hide Details" %}');
                } else {
                    $(this).html('<i class="fas fa-eye"></i> {% trans "Show Details" %}');
                }
            });

            // View switching
            $("#viewTable, #hubViewTable").click(function(){
                $("#tableView").show();
                $("#hubView").hide();
                $("#viewTable, #hubViewTable").addClass('active').removeClass('btn-outline-primary').addClass('btn-primary');
                $("#viewHub, #hubViewHub").removeClass('active').removeClass('btn-primary').addClass('btn-outline-primary');
            });

            $("#viewHub, #hubViewHub").click(function(){
                $("#tableView").hide();
                $("#hubView").show();
                $("#viewHub, #hubViewHub").addClass('active').removeClass('btn-outline-primary').addClass('btn-primary');
                $("#viewTable, #hubViewTable").removeClass('active').removeClass('btn-primary').addClass('btn-outline-primary');
                
                // Initialize hub view if not already done
                if (!window.hubInitialized) {
                    initializeHubView();
                    window.hubInitialized = true;
                }
            });
        });

        // Hub and Spoke Visualization
        function initializeHubView() {
            const svg = document.getElementById('hubSpokeSvg');
            if (!svg) return;

            // Clear existing peer elements
            const existingPeers = svg.querySelectorAll('.peer-node, .peer-connection, .peer-label, .peer-ip-label, .peer-stats');
            existingPeers.forEach(el => el.remove());

            // Get peer data from the table
            const peerRows = document.querySelectorAll('#tableView tbody tr[data-uuid]');
            const peerCount = peerRows.length;
            
            if (peerCount === 0) return;

            const centerX = 250;
            const centerY = 250;
            const radius = 180;
            const peerRadius = 25;

            // Calculate positions for peers in a circle
            peerRows.forEach((row, index) => {
                const uuid = row.getAttribute('data-uuid');
                const peerNameElement = row.querySelector('.peer-name');
                const peerIPElement = row.querySelector('.peer-ip');
                const throughputElement = row.querySelector('.throughput-display');
                const handshakeElement = row.querySelector('.handshake-display');
                const storedHandshakeElement = row.querySelector('[id^="peer-stored-latest-handshake-"]');
                
                // Get the actual text content
                const peerName = peerNameElement ? peerNameElement.textContent.trim() : 'Unknown Peer';
                const peerIP = peerIPElement ? peerIPElement.textContent.trim() : 'No IP';
                const throughput = throughputElement ? throughputElement.textContent.trim() : '-- Kbps';
                const handshake = handshakeElement ? handshakeElement.textContent.trim() : '--';
                const storedHandshake = storedHandshakeElement ? storedHandshakeElement.textContent.trim() : '0';
                
                // Debug logging
                console.log('Peer data:', { peerName, peerIP, throughput, handshake, storedHandshake });
                
                // Determine if peer is actually online using the stored handshake timestamp
                const isOnline = storedHandshake !== '0' && storedHandshake !== '' && parseInt(storedHandshake) > 0;
                
                // Calculate angle for this peer
                const angle = (2 * Math.PI * index) / peerCount;
                const x = centerX + radius * Math.cos(angle);
                const y = centerY + radius * Math.sin(angle);

                // Create connection line
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('class', 'peer-connection');
                line.setAttribute('x1', centerX);
                line.setAttribute('y1', centerY);
                line.setAttribute('x2', x);
                line.setAttribute('y2', y);
                line.setAttribute('data-peer-uuid', uuid);
                svg.appendChild(line);

                // Create peer node
                const peerNode = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                peerNode.setAttribute('class', isOnline ? 'peer-node' : 'peer-node offline');
                peerNode.setAttribute('cx', x);
                peerNode.setAttribute('cy', y);
                peerNode.setAttribute('r', peerRadius);
                peerNode.setAttribute('data-uuid', uuid);
                peerNode.setAttribute('data-peer-name', peerName);
                peerNode.setAttribute('data-peer-ip', peerIP);
                peerNode.setAttribute('data-throughput', throughput);
                peerNode.setAttribute('data-handshake', handshake);
                
                // Add click handler
                peerNode.addEventListener('click', function() {
                    openPeerModal(uuid);
                });
                
                // Add hover handlers
                peerNode.addEventListener('mouseenter', function(e) {
                    showTooltip(e, peerName, peerIP, throughput, handshake);
                });
                
                peerNode.addEventListener('mouseleave', function() {
                    hideTooltip();
                });
                
                svg.appendChild(peerNode);

                // Create peer name label (above the node)
                const nameLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                nameLabel.setAttribute('class', 'peer-label');
                nameLabel.setAttribute('x', x);
                nameLabel.setAttribute('y', y - 45);
                nameLabel.textContent = peerName.length > 12 ? peerName.substring(0, 12) + '...' : peerName;
                svg.appendChild(nameLabel);

                // Create IP label (below the node)
                const ipLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                ipLabel.setAttribute('class', 'peer-ip-label');
                ipLabel.setAttribute('x', x);
                ipLabel.setAttribute('y', y + 45);
                ipLabel.textContent = peerIP;
                svg.appendChild(ipLabel);

                // Create status label (further below)
                const statusLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                statusLabel.setAttribute('class', 'peer-stats');
                statusLabel.setAttribute('x', x);
                statusLabel.setAttribute('y', y + 60);
                statusLabel.textContent = isOnline ? ' Online' : ' Offline';
                statusLabel.setAttribute('fill', isOnline ? '#28a745' : '#dc3545');
                svg.appendChild(statusLabel);
            });
        }

        // Tooltip functions
        function showTooltip(event, name, ip, throughput, handshake) {
            const tooltip = document.getElementById('peerTooltip');
            tooltip.querySelector('.peer-name').textContent = name;
            tooltip.querySelector('.peer-info').innerHTML = 
                `<div>IP: ${ip}</div>
                 <div>Status: ${handshake !== '--' ? 'Online' : 'Offline'}</div>
                 <div>Throughput: ${throughput}</div>
                 <div>Last Handshake: ${handshake}</div>`;
            
            tooltip.style.left = (event.pageX + 10) + 'px';
            tooltip.style.top = (event.pageY - 10) + 'px';
            tooltip.classList.add('show');
        }

        function hideTooltip() {
            const tooltip = document.getElementById('peerTooltip');
            tooltip.classList.remove('show');
        }

        // Update hub view when data changes
        function updateHubView() {
            if (window.hubInitialized && document.getElementById('hubView').style.display !== 'none') {
                initializeHubView();
            }
        }
    </script>

    <!-- VPN Invite functionality with adjustments -->
    <script>
    $(document).ready(function(){
        var inviteData = null; // Store invite details

        // Function to detect mobile device
        function isMobileDevice() {
            return /Mobi|Android/i.test(navigator.userAgent);
        }

        // Handler for VPN Invite button click
        $("#inviteButton").on("click", function(e) {
            e.preventDefault();
            var peerUuid = $('#peerPreviewModal').data('peer-uuid');
            // Hide other content sections
            $(".info-content").hide();
            $(".qr-code-content").hide();
            $(".invite-content").show();

            // Clear previous invite message and input field
            $("#inviteMessage").html("");
            $("#inviteContactInput").val("");

            // Create the invite by calling the API endpoint
            $.ajax({
                url: '/api/peer_invite/',
                data: { peer: peerUuid },
                type: 'GET',
                dataType: 'json',
                success: function(response) {
                    if(response.status === "success") {
                        inviteData = response.invite_data;
                        // Populate invite details in the modal
                        $("#inviteText").text(inviteData.text_body);
                        $("#invitePassword").html("{% trans 'Access Password' %}: <strong>" + inviteData.password + "</strong> {% trans '(Share this password via a separate secure channel)' %}");
                        $("#inviteExpiration").text(new Date(inviteData.expiration).toLocaleString());
                    } else {
                        $("#inviteMessage").html("<div class='alert alert-danger'>" + (response.message || "{% trans 'Unknown error' %}") + "</div>");
                    }
                },
                error: function(xhr, status, error) {
                    var message = "{% trans 'Error creating invite.' %}";
                    try {
                        var resp = xhr.responseJSON;
                        message = resp && resp.message ? resp.message : xhr.statusText;
                    } catch(err) {
                        message = xhr.statusText;
                    }
                    $("#inviteMessage").html("<div class='alert alert-danger'>" + message + "</div>");
                }
            });
        });

        // Back button in the invite section
        $("#backFromInviteButton").on("click", function(e) {
            e.preventDefault();
            $(".invite-content").hide();
            $(".info-content").show();
        });

        // Validate email function
        function isValidEmail(email) {
            var re = /^\S+@\S+\.\S+$/;
            return re.test(email);
        }

        // Validate phone number function (simple check)
        function isValidPhone(phone) {
            var re = /^\+?\d{10,15}$/;
            return re.test(phone);
        }

        // Handler for copying the invite text to clipboard
        $("#copyInviteTextButton").on("click", function(e) {
            e.preventDefault();
            var textToCopy = $("#inviteText").text();
            if (navigator.clipboard) {
                navigator.clipboard.writeText(textToCopy).then(function() {
                    $("#inviteMessage").html("<div class='alert alert-success'>{% trans 'Invite text copied to clipboard.' %}</div>");
                }, function(err) {
                    $("#inviteMessage").html("<div class='alert alert-danger'>{% trans 'Failed to copy text.' %}</div>");
                });
            } else {
                $("#inviteMessage").html("<div class='alert alert-danger'>{% trans 'Clipboard API not supported.' %}</div>");
            }
        });

        // Handler for sending invite via WhatsApp with device detection
        $("#sendInviteWhatsappButton").on("click", function(e) {
            e.preventDefault();
            var contact = $("#inviteContactInput").val().trim();
            if(!isValidPhone(contact)) {
                $("#inviteMessage").html("<div class='alert alert-danger'>{% trans 'Please enter a valid phone number for WhatsApp.' %}</div>");
                return;
            }
            if(inviteData && inviteData.whatsapp_body) {
                var whatsappUrl;
                if(isMobileDevice()){
                    whatsappUrl = "https://api.whatsapp.com/send?phone=" + encodeURIComponent(contact) + "&text=" + encodeURIComponent(inviteData.whatsapp_body);
                } else {
                    whatsappUrl = "https://web.whatsapp.com/send?phone=" + encodeURIComponent(contact) + "&text=" + encodeURIComponent(inviteData.whatsapp_body);
                }
                window.open(whatsappUrl, '_blank');
            } else {
                $("#inviteMessage").html("<div class='alert alert-danger'>{% trans 'Invite data is not available.' %}</div>");
            }
        });

        // Handler for sending invite via Email
        $("#sendInviteEmailButton").on("click", function(e) {
            e.preventDefault();
            var contact = $("#inviteContactInput").val().trim();
            if(!isValidEmail(contact)) {
                $("#inviteMessage").html("<div class='alert alert-danger'>{% trans 'Please enter a valid email address.' %}</div>");
                return;
            }
            if(inviteData && inviteData.uuid) {
                // Send data to n8n webhook
                $.ajax({
                    url: 'https://n8n.portbro.com/webhook/2a3b3bbe-e4f5-41fe-961d-63b863290d26',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        email: contact,
                        invite_url: inviteData.invite_url || inviteData.url,
                        password: inviteData.password,
                        expiration: inviteData.expiration,
                        peer_name: inviteData.peer_name,
                        email_body: `Hello,\n\nYou're invited to join our secure WireGuard VPN network. Please click the link below to access your personalized VPN configuration:\n\n${(inviteData.invite_url || inviteData.url).replace('token', 'token=')}\n\nNote: This invitation link will expire in 30 minutes. If you need a new link after expiration, please request another invite.\n\nAccess Password: ${inviteData.password}`
                    }),
                    success: function(response) {
                        $("#inviteMessage").html("<div class='alert alert-success'>{% trans 'Invite details sent successfully.' %}</div>");
                    },
                    error: function(xhr, status, error) {
                        $("#inviteMessage").html("<div class='alert alert-danger'>{% trans 'Error sending invite details.' %}</div>");
                    }
                });
            } else {
                $("#inviteMessage").html("<div class='alert alert-danger'>{% trans 'Invite data is not available.' %}</div>");
            }
        });

        // Handler for refreshing the invite (update expiration and content)
        $("#refreshInviteButton").on("click", function(e) {
            e.preventDefault();
            if(inviteData && inviteData.uuid) {
                $.ajax({
                    url: '/api/peer_invite/',
                    data: { invite: inviteData.uuid, action: 'refresh' },
                    type: 'GET',
                    dataType: 'json',
                    success: function(response) {
                        if(response.status === "success") {
                            // Update the invite details
                            inviteData = response.invite_data;
                            $("#inviteText").text(inviteData.text_body);
                            $("#invitePassword").html("{% trans 'Access Password' %}: <strong>" + inviteData.password + "</strong> {% trans '(Share this password via a separate secure channel)' %}");
                            $("#inviteExpiration").text(new Date(inviteData.expiration).toLocaleString());
                            $("#inviteMessage").html("<div class='alert alert-success'>" + (response.message || xhr.statusText) + "</div>");
                        } else {
                            $("#inviteMessage").html("<div class='alert alert-danger'>" + (response.message || "{% trans 'Error refreshing invite.' %}") + "</div>");
                        }
                    },
                    error: function(xhr, status, error) {
                        var message = "{% trans 'Error refreshing invite.' %}";
                        try {
                            var resp = xhr.responseJSON;
                            if (resp && resp.message) {
                                message = resp.message;
                            } else {
                                message = xhr.statusText;
                            }
                        } catch(err) {
                            message = xhr.statusText;
                        }
                        $("#inviteMessage").html("<div class='alert alert-danger'>" + message + "</div>");
                    }
                });
            } else {
                $("#inviteMessage").html("<div class='alert alert-danger'>{% trans 'No invite data available to refresh.' %}</div>");
            }
        });

        // Handler for Close Invite button (which deletes the invite)
        $("#closeInviteButton").on("click", function(e) {
            e.preventDefault();
            if(inviteData && inviteData.uuid) {
                $.ajax({
                    url: '/api/peer_invite/',
                    data: { invite: inviteData.uuid, action: 'delete' },
                    type: 'GET',
                    dataType: 'json',
                    success: function(response) {
                        // Hide invite section and show info content regardless of API response
                        $(".invite-content").hide();
                        $(".info-content").show();
                        inviteData = null;
                    },
                    error: function(xhr, status, error) {
                        $("#inviteMessage").html("<div class='alert alert-danger'>{% trans 'Error closing invite:' %} " + error + "</div>");
                    }
                });
            } else {
                $(".invite-content").hide();
                $(".info-content").show();
            }
        });
    });
    </script>

    <script>
function showNxsAlertAndDownload() {
    var peerName = document.getElementById('peerPreviewModalLabel').innerText;
    var peerAllowedIpsRaw = document.getElementById('peerAllowedIPs').innerText;
    var peerAllowedIps = peerAllowedIpsRaw.replace(/\/\d{1,2}/g, '');

    alert(
        'NoMachine .NXS file will be generated!\n\n' +
        'Peer Name: ' + peerName + '\n' +
        'Wireguard IP Address: ' + peerAllowedIps
    );

    var nxsContent = `<!DOCTYPE NXClientSettings>
<NXClientSettings version="2.3" application="nxclient" >
 <group name="Advanced" >
  <option key="Enable remote cursor tracking" value="" />
  <option key="Disable updating clipboard on mouse selection" value="false" />
  <option key="Grab keyboard input" value="" />
  <option key="Grab mouse input" value="" />
  <option key="Enable HTTP proxy" value="false" />
  <option key="HTTP proxy host" value="" />
  <option key="HTTP proxy port" value="8080" />
  <option key="HTTP proxy password" value="EMPTY_PASSWORD" />
  <option key="Remember HTTP proxy password" value="false" />
  <option key="HTTP proxy username" value="" />
  <option key="Emulate middle mouse button" value="" />
  <option key="Use TOR for SOCKS proxy connections" value="false" />
  <option key="Use URL for automatic proxy configuration" value="false" />
  <option key="Manual proxy configuration type" value="http" />
  <option key="Proxy configuration mode" value="automatic" />
  <option key="Automatic proxy configuration URL" value="" />
  <option key="Swap Control and Command modifiers" value="false" />
 </group>
 <group name="Environment" >
  <option key="Use font server" value="false" />
  <option key="Font server host" value="${peerAllowedIps}" />
  <option key="Font server port" value="7100" />
 </group>
 <group name="General" >
  <option key="Automatically accept new hosts identification key" value="false" />
  <option key="Connection request greeting message" value="" />
  <option key="Automatically connect to session with specified ID" value="" />
  <option key="Enable session auto-resize" value="" />
  <option key="Physical desktop auto-resize" value="false" />
  <option key="Virtual desktop auto-resize" value="false" />
  <option key="Close the client application when a single session terminates" value="" />
  <option key="Connection service" value="nx" />
  <option key="Always create a physical desktop on a headless Linux host" value="false" />
  <option key="View a specific monitor among available monitors" value="0" />
  <option key="Command line" value="" />
  <option key="Use custom server" value="false" />
  <option key="Custom server command" value="/etc/NX/nxserver" />
  <option key="Custom Unix Desktop" value="" />
  <option key="NoMachine daemon port" value="4000" />
  <option key="Connect to this node when manual selection is enabled" value="" />
  <option key="Connect to this server when manual selection is enabled" value="" />
  <option key="Desktop" value="" />
  <option key="Disable SHM" value="false" />
  <option key="Disable emulate shared pixmaps" value="false" />
  <option key="Use render" value="true" />
  <option key="Try to wake up server when it is powered off" value="true" />
  <option key="Last connection time" value="1755813302" />
  <option key="Link quality" value="5" />
  <option key="Platform of the last connection" value="" />
  <option key="Node primary display resolution" value="" />
  <option key="Node UUID" value="" />
  <option key="Recently connected nodes" value="" />
  <option key="Physical desktop resize mode" value="scaled" />
  <option key="Session resize mode" value="" />
  <option key="Virtual desktop resize mode" value="viewport" />
  <option key="Server MAC address" value="" />
  <option key="Resize the remote screen upon connecting" value="no" />
  <option key="Resolution" value="" />
  <option key="Use WebRTC for multimedia data" value="true" />
  <option key="Save connection request greeting message" value="false" />
  <option key="Remember session window size and position" value="" />
  <option key="Remember password" value="false" />
  <option key="Remember username" value="true" />
  <option key="Session screenshot" value="" />
  <option key="Server hardware" value="" />
  <option key="Server host" value="${peerAllowedIps}" />
  <option key="Server port" value="22" />
  <option key="Server product" value="" />
  <option key="Server product version" value="" />
  <option key="Server hardware specifications" value="" />
  <option key="Session" value="" />
  <option key="Show connection request greeting message panel" value="true" />
  <option key="Show expiring license warning message" value="true" />
  <option key="Show remote audio alert message" value="true" />
  <option key="Show remote display resize message" value="true" />
  <option key="Show remote desktop view mode message" value="true" />
  <option key="UDP communication port" value="" />
  <option key="Use UDP communication for multimedia data" value="true" />
  <option key="Use specific port for UDP communication" value="false" />
  <option key="Virtual desktop" value="false" />
  <option key="VPN mode" value="tunnel" />
  <option key="Enable VPN kill switch" value="false" />
  <option key="NoMachine web server port" value="4443" />
  <option key="Web session information token" value="" />
  <option key="Session window geometry" value="" />
  <option key="Session window state" value="normal" />
  <option key="xdm mode" value="" />
  <option key="xdm broadcast port" value="177" />
  <option key="xdm list host" value="localhost" />
  <option key="xdm list port" value="177" />
  <option key="xdm query host" value="localhost" />
  <option key="xdm query port" value="177" />
  <option key="Use custom resolution" value="false" />
  <option key="Resolution width" value="" />
  <option key="Resolution height" value="" />
 </group>
 <group name="Login" >
  <option key="Always use selected user login" value="false" />
  <option key="Alternate NX Key" value="" />
  <option key="Forward SSH authentication" value="false" />
  <option key="Guest Mode" value="false" />
  <option key="Guest password" value="" />
  <option key="Guest username" value="" />
  <option key="Guest server" value="" />
  <option key="Guest desktop sharing mode" value="false" />
  <option key="Last selected user login" value="" />
  <option key="Server authentication method" value="system" />
  <option key="Auth" value="EMPTY_PASSWORD" />
  <option key="User" value="" />
  <option key="Wallix login" value="" />
  <option key="NX login method" value="password" />
  <option key="Private key for NX authentication" value="" />
  <option key="Use alternate smart card module" value="false" />
  <option key="Smart card authentication module" value="" />
  <option key="Private key" value="" />
  <option key="Public Key" value="" />
  <option key="System auth" value="EMPTY_PASSWORD" />
  <option key="Two-factor authentication password" value="EMPTY_PASSWORD" />
  <option key="Remember NoMachine password" value="false" />
  <option key="Remember two-factor authentication password" value="false" />
  <option key="Imported private key for NX authentication" value="" />
  <option key="Use imported private key for NX authentication" value="false" />
  <option key="Imported private key" value="" />
  <option key="Use imported private key" value="false" />
  <option key="NoMachine Network login code" value="EMPTY_PASSWORD" />
  <option key="Remember NoMachine Network access ID" value="false" />
  <option key="NoMachine Network access ID" value="EMPTY_PASSWORD" />
  <option key="System login method" value="password" />
  <option key="Use alternate NX Key" value="false" />
  <option key="GSSAPI subsystem for the kerberos authentication" value="kerberos" />
  <option key="Kerberos key exchange to identify server host" value="false" />
  <option key="DNS translation when passing server to Kerberos library" value="false" />
 </group>
 <group name="Images" >
  <option key="Disable network-adaptive quality" value="false" />
  <option key="Disable backingstore" value="false" />
  <option key="Disable composite" value="false" />
  <option key="Disable image post-processing" value="false" />
  <option key="Disable frame buffering on decoding" value="false" />
  <option key="Disable lossless display refinement" value="false" />
  <option key="Disable multi-pass display encoding" value="false" />
  <option key="E-reader display update policy" value="false" />
  <option key="Video frame rate for display server" value="30" />
  <option key="Stream downsampling factor" value="0" />
  <option key="Request a specific frame rate" value="false" />
  <option key="Video encoding quality" value="5" />
 </group>
 <group name="Services" >
  <option key="Output audio device" value="autodetect" />
  <option key="Output audio quality" value="5" />
  <option key="Audio" value="true" />
  <option key="IPPPrinting" value="true" />
  <option key="Enable devices sharing" value="true" />
  <option key="Shares" value="true" />
  <option key="Mute audio of the remote physical desktop" value="true" />
  <option key="Input voice device" value="autodetect" />
  <option key="Input voice quality" value="5" />
 </group>
 <group name="VNC Session" >
  <option key="Display" value=":0" />
  <option key="Password" value="EMPTY_PASSWORD" />
  <option key="Remember login credentials" value="false" />
  <option key="Remember" value="false" />
  <option key="Server" value="" />
 </group>
 <group name="Windows Session" >
  <option key="Application" value="" />
  <option key="Authentication" value="2" />
  <option key="Domain" value="" />
  <option key="Password" value="EMPTY_PASSWORD" />
  <option key="Remember login credentials" value="false" />
  <option key="Remember" value="false" />
  <option key="Run application" value="false" />
  <option key="Server" value="" />
  <option key="User" value="" />
 </group>
 <group name="Remote Session" >
  <option key="Host" value="" />
  <option key="Port" value="" />
  <option key="Username" value="" />
  <option key="Password" value="EMPTY_PASSWORD" />
  <option key="Remember login credentials" value="false" />
  <option key="Fingerprint" value="" />
 </group>
</NXClientSettings>
`;

    var blob = new Blob([nxsContent], { type: 'application/xml' });
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = (peerName ? peerName.replace(/\s+/g, '_') : 'nomachine') + '.nxs';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}
</script>

<!-- Update the button to use the new function -->
<a href="#" class="btn btn-outline-primary" id="generatenxs"
   onclick="showNxsAlertAndDownload();"><i class="far fa-file"></i> {% trans '.NXS File' %}</a>
    </script>

{% endblock %}
