{% extends "base.html" %}
{% load i18n %}

{% block content %}

<div class="card card-primary card-outline">
    <div class="card-header">
        <h3 class="card-title">
            <i class="fas fa-user"></i>
            {% trans 'Device Settings' %}
        </h3>
        <div class="card-tools">
            <a class="btn btn-outline-secondary btn-sm" href="/peer/list/?uuid={{ current_peer.wireguard_instance.uuid }}#peer-{{ current_peer.public_key }}">
                <i class="fas fa-arrow-left"></i> {% trans 'Back to Devices' %}
            </a>
        </div>
    </div>
    <form method="post">
        {% csrf_token %}
        <div class="card-body">
            <!-- Simple Name Input -->
            <div class="row">
                <div class="col-lg-8">
                    <div class="form-group">
                        <label for="{{ form.name.id_for_label }}" class="h5">
                            <i class="fas fa-tag text-primary"></i>
                            {% trans 'Device Name' %}
                        </label>
                        <input type="text" class="form-control form-control-lg" id="{{ form.name.id_for_label }}" name="{{ form.name.html_name }}" placeholder="{% trans 'e.g., John\'s iPhone, Office Laptop, Home Server' %}" value="{{ form.name.value|default_if_none:'' }}">
                        <small class="form-text text-muted">
                            <i class="fas fa-info-circle"></i>
                            {% trans 'Give this device a friendly name so you can easily identify it' %}
                        </small>
                    </div>
                </div>
            </div>

            <!-- Device Status Card -->
            <div class="row mt-4">
                <div class="col-lg-12">
                    <div class="card card-info">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="fas fa-info-circle"></i>
                                {% trans 'Device Information' %}
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>{% trans 'Status:' %}</strong> 
                                        <span class="badge badge-success">
                                            <i class="fas fa-check-circle"></i> {% trans 'Ready to Connect' %}
                                        </span>
                                    </p>
                                    <p><strong>{% trans 'IP Address:' %}</strong> 
                                        <code>{% for ip in current_peer.peerallowedip_set.all %}{% if ip.config_file == 'server' and ip.priority == 0 %}{{ ip.allowed_ip }}{% endif %}{% empty %}Not assigned{% endfor %}</code>
                                    </p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>{% trans 'Connection Type:' %}</strong> 
                                        <span class="badge badge-primary">{% trans 'VPN Tunnel' %}</span>
                                    </p>
                                    <p><strong>{% trans 'Network:' %}</strong> 
                                        <code>{{ current_peer.wireguard_instance.name|default:"Default" }}</code>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Simple Traffic Graph -->
            <div class="row mt-4">
                <div class="col-lg-12">
                    <div class="card card-light">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="fas fa-chart-line text-success"></i>
                                {% trans 'Data Usage' %}
                            </h5>
                            <div class="card-tools">
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-outline-primary active" data-period="1d">{% trans 'Today' %}</button>
                                    <button type="button" class="btn btn-outline-primary" data-period="7d">{% trans 'Week' %}</button>
                                    <button type="button" class="btn btn-outline-primary" data-period="30d">{% trans 'Month' %}</button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="text-center">
                                <img id="graphImg" src="/rrd/graph/?peer={{ current_peer.uuid }}&period=1d" class="img-fluid" alt="{% trans 'No data usage yet - connect your device to see usage statistics' %}" onerror="this.onerror=null; this.style.display='none'; this.insertAdjacentHTML('afterend', '<div class=\'alert alert-info\'><i class=\'fas fa-info-circle\'></i> ' + this.alt + '</div>');">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
        <div class="card-footer bg-light">
            <div class="row">
                <div class="col-md-6">
                    <button type="submit" class="btn btn-primary btn-lg" id="saveButton" disabled>
                        <i class="fas fa-save"></i> {% trans 'Save Device Name' %}
                    </button>
                </div>
                <div class="col-md-6 text-right">
                    <a href='javascript:void(0)' class='btn btn-outline-danger' data-command='delete' onclick='openCommandDialog(this)' id="removeButton" style="pointer-events: none; opacity: 0.5;">
                        <i class="fas fa-trash"></i> {% trans 'Remove Device' %}
                    </a>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block custom_page_scripts %}

<script>
    // Enable/disable buttons based on device name input
    document.addEventListener('DOMContentLoaded', function() {
        var nameInput = document.getElementById('{{ form.name.id_for_label }}');
        var saveButton = document.getElementById('saveButton');
        var removeButton = document.getElementById('removeButton');
        
        function updateButtons() {
            var hasName = nameInput.value.trim().length > 0;
            
            // Enable/disable save button
            saveButton.disabled = !hasName;
            
            // Enable/disable remove button
            if (hasName) {
                removeButton.style.pointerEvents = 'auto';
                removeButton.style.opacity = '1';
            } else {
                removeButton.style.pointerEvents = 'none';
                removeButton.style.opacity = '0.5';
            }
        }
        
        // Check initial state
        updateButtons();
        
        // Update on input change
        nameInput.addEventListener('input', updateButtons);
        nameInput.addEventListener('paste', function() {
            // Handle paste events with a slight delay
            setTimeout(updateButtons, 10);
        });
    });
</script>

<script>
    // Simple confirmation dialog for removing device
    function openCommandDialog(element) {
        var command = element.getAttribute('data-command');
        if (command === 'delete') {
            if (confirm("{% trans 'Are you sure you want to remove this device? This action cannot be undone.' %}")) {
                var url = "?peer={{ current_peer.uuid }}&action=delete&confirmation=delete";
                window.location.href = url;
            }
        }
    }
</script>

<script>
    // Simple traffic graph period switching
    document.addEventListener('DOMContentLoaded', function(){
        var buttons = document.querySelectorAll('.btn-group button[data-period]');
        buttons.forEach(function(button){
            button.addEventListener('click', function(e){
                e.preventDefault();
                
                // Remove active class from all buttons
                buttons.forEach(function(btn) {
                    btn.classList.remove('active');
                });
                
                // Add active class to clicked button
                this.classList.add('active');
                
                // Update graph
                var period = this.getAttribute('data-period');
                var newSrc = '/rrd/graph/?peer={{ current_peer.uuid }}&period=' + period;
                var imgElement = document.getElementById('graphImg');
                if(imgElement){
                    imgElement.setAttribute('src', newSrc);
                }
            });
        });
    });
</script>

{% endblock %}
